<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Messages – Trader Route</title>

  <meta name="description" content="Private chat between Trader Route members. Communicate securely with buyers and suppliers.">
  <meta name="author" content="Trader Route">
  <link rel="icon" href="assets/logos.png" />

  <style>
    :root{
      --green:#008b6a;
      --green-dark:#006b52;
      --bg:#f6f8fa;
    }
    body{
      font-family:"Inter","Segoe UI",Arial,sans-serif;
      background:var(--bg);
      margin:0;
      color:#222;
    }
    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      background:#fff;
      padding:12px 20px;
      border-bottom:1px solid #ddd;
      box-shadow:0 2px 4px rgba(0,0,0,.05);
      position:sticky;
      top:0;
      z-index:10;
    }
    header .brand{
      display:flex;
      align-items:center;
      gap:10px;
      cursor:pointer;
    }
    header img{height:50px;}
    header .tagline{font-size:14px;color:#555;font-weight:600;}
    .chat{
      max-width:900px;
      margin:30px auto;
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius:12px;
      box-shadow:0 2px 8px rgba(0,0,0,.08);
      display:flex;
      flex-direction:column;
      height:78vh;
      overflow:hidden;
    }
    .head{
      background:var(--green);
      color:#fff;
      padding:14px 18px;
      font-weight:700;
    }
    .list{
      flex:1;
      overflow-y:auto;
      padding:18px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .bubble{
      padding:10px 14px;
      border-radius:10px;
      max-width:70%;
      font-size:14px;
      line-height:1.4;
    }
    .sent{
      background:var(--green);
      color:#fff;
      align-self:flex-end;
      border-bottom-right-radius:0;
    }
    .recv{
      background:#e9e9e9;
      color:#111;
      align-self:flex-start;
      border-bottom-left-radius:0;
    }
    .input{
      display:flex;
      gap:10px;
      padding:14px;
      border-top:1px solid #e5e7eb;
    }
    .input input{
      flex:1;
      padding:10px;
      border:1px solid #ccc;
      border-radius:6px;
      font-size:14px;
    }
    .input button{
      background:var(--green);
      color:#fff;
      border:none;
      border-radius:6px;
      padding:10px 18px;
      font-weight:700;
      cursor:pointer;
    }
    .input button:hover{
      background:var(--green-dark);
    }
    .status{
      font-size:12px;
      color:#6b7280;
      text-align:center;
      margin:5px 0;
    }
  </style>
</head>
<body>
  <header>
    <div class="brand" onclick="location.href='index.html'">
      <img src="assets/logos.png" alt="Trader Route Logo" />
      <span class="tagline">The Silk Road of E-Commerce</span>
    </div>
  </header>

  <div class="chat">
    <div class="head" id="who">Chat</div>
    <div class="list" id="list"></div>
    <div class="input">
      <input type="text" id="msg" placeholder="Type your message..." />
      <button id="send">Send</button>
    </div>
    <div class="status" id="status"></div>
  </div>

  <script>
    // === User Info ===
    const me = JSON.parse(localStorage.getItem("loggedUser") || '{"email":"me@traderroute.com"}');
    const to = new URLSearchParams(location.search).get("to") || "unknown@user.com";

    const who  = document.getElementById("who");
    const list = document.getElementById("list");
    const msg  = document.getElementById("msg");
    const send = document.getElementById("send");
    const status = document.getElementById("status");

    who.textContent = "Chat with " + to;

    function getMessages(){
      try { return JSON.parse(localStorage.getItem("messages") || "[]"); }
      catch { return []; }
    }
    function saveMessages(arr){
      localStorage.setItem("messages", JSON.stringify(arr));
    }

    // === Render Messages ===
    function render(){
      const all = getMessages();
      list.innerHTML = "";
      const mine = all.filter(m =>
        (m.from === me.email && m.to === to) ||
        (m.from === to && m.to === me.email)
      );
      mine.forEach(m=>{
        const b = document.createElement("div");
        b.className = "bubble " + (m.from === me.email ? "sent" : "recv");
        b.textContent = m.text;
        list.appendChild(b);
      });
      list.scrollTop = list.scrollHeight;
    }

    // === Send Message (Local + Server Email Notify) ===
    function sendMessage(){
      const text = msg.value.trim();
      if(!text) return;
      const all = getMessages();
      all.push({ from: me.email, to, text, time: Date.now() });
      saveMessages(all);
      msg.value = "";
      render();

      // ✅ Send to server (email notification + store)
      fetch("server/send_message.php", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ from: me.email, to, text })
      })
      .then(res => res.json())
      .then(d => {
        console.log("Server response:", d);
        status.textContent = d.message || "Message sent.";
        setTimeout(()=>status.textContent="",3000);
      })
      .catch(err => {
        console.error("Send error:", err);
        status.textContent = "Error sending message.";
      });
    }

    send.onclick = sendMessage;
    msg.addEventListener("keypress", e=>{ if(e.key==="Enter") sendMessage(); });
    setInterval(render, 4000);
    render();
  </script>
</body>
</html>
